<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="LOB.DATA">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://www.lobdata.com.br/img/banner/header_profile.jpg">

    
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:image" content="https://www.cedricscherer.com/img/banner/banner.png" >
    

    

    
      <meta name="title" content="Demand Forecasting of Brazilian Commodities" />
      <meta property="og:title" content="Demand Forecasting of Brazilian Commodities - Luba" />
      <meta property="twitter:title" content="Demand Forecasting of Brazilian Commodities - Luba" />
      <meta property="twitter:text:title" content="Demand Forecasting of Brazilian Commodities - Luba" />
    

    
      <meta name="description" content="Blog by LuBa">
      <meta property="og:description" content="Blog by LuBa" />
      <meta property="twitter:description" content="Blog by LuBa" />
    

    

    <meta name="keyword"  content="Data Visualization, Data Science, Programming, Web Development">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Demand Forecasting of Brazilian Commodities - Luba</title>

    <link rel="canonical" href="/2020/10/25/demand-forecasting-of-brazilian-commodities/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/syntax.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/foundation.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">LOB.DATA</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Blog</a>
                    </li>
                    
                    <li>
                        <a href="/categories/aplica%C3%A7%C3%B5es">aplicações</a>
                    </li>
                    
                    <li>
                        <a href="/categories/projetos">projetos</a>
                    </li>
                    
                    <li>
                        <a href="/categories/tutorials">tutorials</a>
                    </li>
                    

		    
                        <li><a href="/top/portfolio/">Portfolio</a></li>
                    
                        <li><a href="/top/dataviz/">Gallery</a></li>
                    
                        <li><a href="/top/about/">About Me</a></li>
                    
                        <li><a href="/top/links/">Links</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/post_0_4.png')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/project" title="Project">
                            Project
                        </a>
                        
                        <a class="tag" href="/tags/data-science" title="Data Science">
                            Data Science
                        </a>
                        
                        <a class="tag" href="/tags/machine-learning" title="Machine Learning">
                            Machine Learning
                        </a>
                        
                        <a class="tag" href="/tags/time-series" title="Time Series">
                            Time Series
                        </a>
                        
                    </div>
                    <h1>Demand Forecasting of Brazilian Commodities</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
			Posted by
			
			    Luciano
			
			on
			Sunday, October 25, 2020
                        
                            <span id="/2020/10/25/demand-forecasting-of-brazilian-commodities/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("", "");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h3>Table of Contents</h3>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#software-requirement">Software Requirement</a></li>
    <li><a href="#exploratory-data-analysis">Exploratory Data Analysis</a>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#production-over-time">Production over time</a></li>
        <li><a href="#most-important-commodities">Most Important Commodities</a></li>
        <li><a href="#routes">Routes</a></li>
        <li><a href="#trade-partners">Trade Partners</a></li>
        <li><a href="#states-and-commodities">States and Commodities</a></li>
      </ul>
    </li>
    <li><a href="#data-modeling">Data Modeling</a></li>
    <li><a href="#a-quick-review-of-modeltime">A quick review of modeltime</a>
      <ul>
        <li><a href="#soybean">Soybean</a></li>
        <li><a href="#corn">Corn</a></li>
        <li><a href="#sugar">Sugar</a></li>
        <li><a href="#next-steps-important">Next Steps! (Important)</a></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <h1 id="demand-forecasting-of-brazilian-commodities">Demand Forecasting of Brazilian Commodities</h1>
<p><img src="/img/demand_forecasting/promotional.png" alt="Plot"></p>
<blockquote>
<p>Soybean, Corn, Sugar, Soybean Meal, Soybean Oil and Wheat (left to right).</p>
</blockquote>
<p><strong>Demand Forecasting</strong> is a technique for estimation of probable demand for a product or services. It is based on the analysis of past demand for that product or service in the present market condition. Demand forecasting should be done on a scientific basis and facts and events related to forecasting should be considered.</p>
<p>Therefore, in simple words, we can say that after gathering information about various aspects of the market and demand based on the past, is possible to estimate future demand. What we call forecasting of demand.</p>
<p>For example, suppose we sold 200, 250, 300 units of product X in January, February, and March respectively. Now we can say that there will be a demand for Y units approximately of product X in April.</p>
<p>And you can ask, Why should I matter with demand forecasting? Good question, down below I point to you some <em>key advantages</em>:</p>
<ul>
<li>More effective production scheduling</li>
<li>Inventory management and reduction</li>
<li>Cost reduction</li>
<li>Optimized transport logistics</li>
<li>Increased customer satisfaction</li>
</ul>
<p>Those are just some benefits in <em>forecasting demand</em>. As this is a task applicable in almost any business area, the concepts and approaches used here can be extrapolate for your problem too, with specific adjustments.</p>
<p>This project has the aim of forecast the next 3 years of exports of top 3 Brazilian commodities: soybean, corn and sugar. But not just that, I&rsquo;ll cover also the following steps of a Data Science project: <strong>exploratory data analysis</strong>, <strong>data preparation</strong>, <strong>data cleaning</strong>, <strong>feature engineering</strong> and <strong>modeling</strong>.</p>
<p>The dataset used here came from a public source available by clicking <a href="http://comexstat.mdic.gov.br/en/home" title="Data">here</a>.</p>
<h2 id="software-requirement">Software Requirement</h2>
<p>If you want to reproduce the project in your environment, I suggest you to install the following packages first, before load them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Data Exploration</span>
<span style="color:#a6e22e">library</span>(tidyverse)
<span style="color:#a6e22e">library</span>(skimr)
<span style="color:#a6e22e">library</span>(lubridate)
<span style="color:#a6e22e">library</span>(tidytext)
<span style="color:#a6e22e">library</span>(timetk)
<span style="color:#a6e22e">library</span>(gt)

<span style="color:#75715e"># color pallete</span>
<span style="color:#a6e22e">library</span>(tidyquant)

<span style="color:#75715e"># modeling</span>
<span style="color:#a6e22e">library</span>(tidymodels)
<span style="color:#a6e22e">library</span>(modeltime)
</code></pre></div><p><img src="/img/demand_forecasting/shall_we_begin.gif" alt="gif"></p>
<h2 id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<p>As mentioned before, the dataset came from a public source called <em>COMEX STAT</em>. This website provides free access to Brazilian foreign trade statistics.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># reading the data and converting categorical features to factor</span>
exp_imp_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read_csv</span>(<span style="color:#e6db74">&#34;data/data_comexstat.csv&#34;</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">mutate_if</span>(is.character, as_factor)

</code></pre></div><p>As usual, I always create a dictionary of the dataset I&rsquo;m working just to keep in mind the meaning of each variable, see the following list:</p>
<ul>
<li><strong>date</strong>: date where occurred the transaction of export or import (our time series information).</li>
<li><strong>product</strong>: commodities (sugar, soybean meal, soybean oil, soybean, corn and wheat).</li>
<li><strong>state</strong>: State responsible for the production.</li>
<li><strong>country</strong>: Country responsible for the transaction</li>
<li><strong>type</strong>: if there is export or import.</li>
<li><strong>route</strong>: route used to transport the commodity.</li>
<li><strong>tons</strong>: quantity export/import.</li>
<li><strong>usd</strong>: commercial currency.</li>
</ul>
<h3 id="overview">Overview</h3>
<p>The data contains all tracking information of monthly imports and exports of a range of products, by brazilian states, by routes (air, sea, ground, etc) and from/to which country.</p>
<p>At the beginning of the process is a good idea to take a general overview of the data, and for that I love the <code>skimr::skim()</code> function, very handy to understand a big picture of your data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">skim</span>(exp_imp_tbl)
</code></pre></div><pre><code>── Data Summary ────────────────────────
                           Values     
Name                       exp_imp_tbl
Number of rows             117965     
Number of columns          8          
_______________________               
Column type frequency:                
  Date                     1          
  factor                   5          
  numeric                  2          
________________________              
Group variables            None       

── Variable type: Date ────────────────────────────────────────────────────────────────────────────────────────────────
  skim_variable n_missing complete_rate min        max        median     n_unique
1 date                  0             1 1997-01-01 2019-12-01 2012-10-01      276

── Variable type: factor ──────────────────────────────────────────────────────────────────────────────────────────────
  skim_variable n_missing complete_rate ordered n_unique top_counts                                    
1 product               0             1 FALSE          6 sug: 35202, soy: 22914, cor: 21872, soy: 18215
2 state                 0             1 FALSE         27 SP: 28713, PR: 17155, MT: 16837, GO: 10981    
3 country               0             1 FALSE        212 Chi: 7437, Par: 7160, Net: 7158, Arg: 4842    
4 type                  0             1 FALSE          2 Exp: 105861, Imp: 12104                       
5 route                 0             1 FALSE          5 Sea: 93870, Gro: 13038, Oth: 6374, Air: 2918  

── Variable type: numeric ─────────────────────────────────────────────────────────────────────────────────────────────
  skim_variable n_missing complete_rate     mean        sd    p0    p25    p50      p75       p100 hist 
1 tons                  0             1   14537.    49779.     0   125.   2000   13534.   1798446. ▇▁▁▁▁
2 usd                   0             1 4813150. 19494116.     0 71552  725000 3895943  903930411  ▇▁▁▁▁
</code></pre><p>As we can see, our dataset have:</p>
<ul>
<li>1 date variable</li>
<li>5 categorical variables</li>
<li>2 numerical variables</li>
</ul>
<p>For our luck there is no missing data in any of these columns. Two things pop up when we look at <code>type</code> and <code>route</code> variables.</p>
<ul>
<li><code>type</code>: Brazil is a country that export more than import (more than 100k of observations on export category).</li>
<li><code>route</code>: The route that Brazil less use (considering exports and imports) is air. And the route more used is sea.</li>
</ul>
<h3 id="production-over-time">Production over time</h3>
<p>We also saw the date range of this date feature, and it&rsquo;s from 1997/01/01 to 2019/01/12. Looking more closely at this feature we can investigate how was the exports from Brazil, considering all states and to everywhere, throughout the time.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># data wrangling before plot</span>
<span style="color:#75715e"># adding two columns: year and month</span>
exp_imp_year_month_tbl <span style="color:#f92672">&lt;-</span> exp_imp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(year <span style="color:#f92672">=</span> <span style="color:#a6e22e">year</span>(date),
         month <span style="color:#f92672">=</span> <span style="color:#a6e22e">month</span>(date, abbr <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, label <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, locale <span style="color:#f92672">=</span> <span style="color:#a6e22e">Sys.setlocale</span>(<span style="color:#e6db74">&#34;LC_COLLATE&#34;</span>, <span style="color:#e6db74">&#34;C&#34;</span>)))

<span style="color:#75715e"># total of tons by year (considering just exports)</span>
expt_year_total_tbl <span style="color:#f92672">&lt;-</span> exp_imp_year_month_tbl <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(year) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(tons)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>()

<span style="color:#75715e"># total of tons for each month of the year (considering just exports)</span>
expt_year_month_total_tbl <span style="color:#f92672">&lt;-</span> exp_imp_year_month_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(year, month) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(tons)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>()

<span style="color:#75715e"># vizualizing the monthly total of tons (1997 - 2020)</span>
expt_year_month_total_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(month <span style="color:#f92672">=</span> month <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">str_to_title</span>() <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_factor</span>()) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> year,
             y <span style="color:#f92672">=</span> total_tons)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">.8</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_line</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>month) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1997</span>, <span style="color:#ae81ff">2000</span>, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2015</span>, <span style="color:#ae81ff">2019</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Total of Tons for the Monthly Exports Between 1997 and 2020&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Considering all Brazilian States, and Soybean, Soybeans Meal, Soybean Oil, Sugar, Corn and Wheat commodities&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(axis.text.x <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>))

</code></pre></div><p><img src="/img/demand_forecasting/plot1.svg" alt="Plot"></p>
<blockquote>
<p>On this monthly chart, we see that there is a higher pronounced growth trend in exports during the months from March to August.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># building vizualizations</span>
<span style="color:#75715e"># vizualizing the annual total of tons export (1997 - 2020)</span>
expt_year_total_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> year,
             y <span style="color:#f92672">=</span> total_tons)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_line</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(breaks <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1997</span>, <span style="color:#ae81ff">2000</span>, <span style="color:#ae81ff">2005</span>, <span style="color:#ae81ff">2010</span>, <span style="color:#ae81ff">2015</span>, <span style="color:#ae81ff">2019</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Total of Tons for the Annual Exports Between 1997 and 2020&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Considering all Brazilian States, and Soybean, Soybeans Meal, Soybean Oil, Sugar, Corn and Wheat commodities&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(axis.text.x <span style="color:#f92672">=</span> <span style="color:#a6e22e">element_text</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>))
</code></pre></div><p><img src="/img/demand_forecasting/plot2.svg" alt="Plot"></p>
<blockquote>
<p>As expected, over the years, the brazilian exports follow a growing trend, even if 2020 bring us a terrible result because of COVID-19, it is likely to go back to the initial trend in the next year.</p>
</blockquote>
<h3 id="most-important-commodities">Most Important Commodities</h3>
<p>We saw before our data have 6 different commodities: Soybean, Sugar, Soybeans Meal, Corn, Soybean Oil and Wheat. Let’s look at them and see which have been more export in the last 5 years.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># data wrangling before plot</span>
<span style="color:#75715e"># filtering for recent years and type == &#34;Export&#34;</span>
<span style="color:#75715e"># total of tons for these groups</span>
top_3_product_exp_tbl <span style="color:#f92672">&lt;-</span> exp_imp_year_month_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(year <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2019</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2015</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_tons_exp <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(tons)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">slice_max</span>(total_tons_exp, n <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)


top_3_product_exp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(product_str <span style="color:#f92672">=</span> <span style="color:#a6e22e">case_when</span>(
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybeans&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Soybean&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;corn&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Corn&#34;</span>,
    <span style="color:#66d9ef">TRUE</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Sugar&#34;</span>
  )) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> total_tons_exp,
             y <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_reorder</span>(product_str, total_tons_exp),
             fill <span style="color:#f92672">=</span> product_str)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;#7EBEF7&#34;</span>, <span style="color:#e6db74">&#34;#2595F5&#34;</span>, <span style="color:#e6db74">&#34;#BBD7F0&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Top 3 - Brazilian Commodities Exports&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Considering the Last 5 Years&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Commodities&#34;</span>
  )

<span style="color:#75715e"># good table to plot</span>
top_3_product_exp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">rename</span>(Commodities <span style="color:#f92672">=</span> product, `Total of Tons` <span style="color:#f92672">=</span> total_tons_exp) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(`Total of Tons` <span style="color:#f92672">=</span> `Total of Tons` <span style="color:#f92672">%&gt;%</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">gt</span>()


</code></pre></div><p><img src="/img/demand_forecasting/plot3.svg" alt="Plot"></p>
<p>The plot above is showing the top 3 commodities exported in Brazil by the last 5 years: soybean, corn and sugar. With the more important being soybean. If we compare with the others, soybeans have 55.5% more than the second (Corn) and 63.2% more than the third (Sugar), it is an enormous difference.</p>
<p><img src="/img/demand_forecasting/table.png" alt="Plot"></p>
<h3 id="routes">Routes</h3>
<p>These commodities we are seeing until now are exported by different routes: sea, ground, air, river and others. Let’s investigate if there is some preference to choose the route and product.</p>
<p>Before building those visualizations, sounds a good idea to keep in mind the most chosen routes, considering all products, to establish a big picture of the situation. Look at the table below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># data wrangling before plot</span>
<span style="color:#75715e"># top exports routes on recent years</span>
tops_routes_exp <span style="color:#f92672">&lt;-</span> exp_imp_year_month_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(year <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2000</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#75715e"># selecting most recent years</span>
  <span style="color:#a6e22e">count</span>(route) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(prop <span style="color:#f92672">=</span> n <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(n))

<span style="color:#75715e"># table</span>
tops_routes_exp <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">rename</span>(Route <span style="color:#f92672">=</span> route, Percent <span style="color:#f92672">=</span> prop) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(Percent <span style="color:#f92672">=</span> Percent <span style="color:#f92672">%&gt;%</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;%&#34;</span>, accuracy <span style="color:#f92672">=</span> <span style="color:#ae81ff">.1</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>n) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">gt</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">tab_header</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Participation of Routes of Exports&#34;</span>
  )
</code></pre></div><p><img src="/img/demand_forecasting/table2.png" alt="Plot"></p>
<p>Now let&rsquo;s see by product and routes what it&rsquo;s happening.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># data wrangling before plot</span>
exp_by_route_product_tbl <span style="color:#f92672">&lt;-</span> exp_imp_year_month_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(product <span style="color:#f92672">=</span> <span style="color:#a6e22e">case_when</span>(
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;corn&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Corn&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybean_meal&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Soybeans Meal&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybean_oil&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Soybean Oil&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sugar&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Sugar&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybeans&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Soybean&#34;</span>,
    <span style="color:#66d9ef">TRUE</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Wheat&#34;</span>
  )) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(route, product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(n <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>()) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(prop_by_route <span style="color:#f92672">=</span> n <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(n)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>()

exp_by_route_product_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> tidytext<span style="color:#f92672">::</span><span style="color:#a6e22e">reorder_within</span>(product, prop_by_route, route),
             y <span style="color:#f92672">=</span> prop_by_route)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>(<span style="color:#a6e22e">aes</span>(fill <span style="color:#f92672">=</span> prop_by_route)) <span style="color:#f92672">+</span>
  tidytext<span style="color:#f92672">::</span><span style="color:#a6e22e">scale_x_reordered</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_flip</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>route, scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_gradient</span>(high <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#144582&#34;</span>, low <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#D4E8FF&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">percent_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;%&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Proportion of Commodities Exports for all Different Routes&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Commodities&#34;</span>
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Proportion by Routes&#34;</span>)

</code></pre></div><p><img src="/img/demand_forecasting/plot4.svg" alt="Plot"></p>
<p>Although most products are transported by sea (table above), we observe that depending on the route there is a preference for the product that will be exported.</p>
<p>Considering three major products exported in each route, we have:</p>
<ul>
<li><strong>Sea</strong>: sugar, soybean and soybeans meal.</li>
<li><strong>Ground</strong>: soybean oil, sugar and corn.</li>
<li><strong>Air</strong>: corn (much more), soybean and sugar.</li>
<li><strong>Other</strong>: sugar, soybean oil and corn.</li>
<li><strong>River</strong>: soybean, corn and sugar.</li>
</ul>
<p>And a closer look at soybean, give us the following chart:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># data wrangling before plot</span>
tops_routes_sugar_exp <span style="color:#f92672">&lt;-</span> exp_imp_year_month_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybeans&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(year <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2000</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#75715e"># selecting most recent years</span>
  <span style="color:#a6e22e">count</span>(route) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(prop <span style="color:#f92672">=</span> n <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(n))

tops_routes_sugar_exp <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> prop,
             y <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_reorder</span>(route, prop),
             fill <span style="color:#f92672">=</span> route)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">percent_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;%&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>( <span style="color:#e6db74">&#34;#2595F5&#34;</span>, <span style="color:#e6db74">&#34;#BBD7F0&#34;</span>, <span style="color:#e6db74">&#34;#BBD7F0&#34;</span>,<span style="color:#e6db74">&#34;#BBD7F0&#34;</span>,<span style="color:#e6db74">&#34;#7EBEF7&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Participation in Each Route of Brazilian Soybean Exports (1997 - 2020)&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Proportions&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Exportation Routes&#34;</span>
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> F)
</code></pre></div><p><img src="/img/demand_forecasting/plot5.svg" alt="Plot"></p>
<blockquote>
<p>Yeah, a very high concentration in sea transportation route.</p>
</blockquote>
<h3 id="trade-partners">Trade Partners</h3>
<p>Let’s look at our data by another perspective, <em>trade partners</em>. Brazil has a lot of trade partners, these are countries which with Brazil export and import more, and sounds a good idea to know which countries Brazil has been doing business.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># data wrangling before plot</span>
<span style="color:#75715e"># filtering by the last 5 years</span>
<span style="color:#75715e"># first look on the exportation</span>
exp_trade_partners_corn_sugar_tbl <span style="color:#f92672">&lt;-</span> exp_imp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(year <span style="color:#f92672">=</span> <span style="color:#a6e22e">year</span>(date)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(year <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2019</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2014</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># removing special characters </span>
  <span style="color:#a6e22e">mutate</span>(country2 <span style="color:#f92672">=</span> country <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">str_replace_all</span>(<span style="color:#e6db74">&#34;[[:punct:]]&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">str_trim</span>(side <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;both&#34;</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(year, country2) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_usd <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(usd)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(year_fc <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(year),
         name <span style="color:#f92672">=</span> <span style="color:#a6e22e">reorder_within</span>(country2, total_usd, year_fc))

exp_trade_partners_corn_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># threshold to selecting some countries</span>
  <span style="color:#a6e22e">filter</span>(total_usd <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100000000</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> name,
             y <span style="color:#f92672">=</span> total_usd,
             fill <span style="color:#f92672">=</span> year)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>(show.legend <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_flip</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_reordered</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">dollar_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>year, scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free&#34;</span>, nrow <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Trade Partners Evaluation for the last 5 years of Exportation&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Considering all Brazilian States, and Soybean, Soybeans Meal, Soybean Oil, Sugar, Corn and Wheat Commodities&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of U.S. Dollars&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>()

</code></pre></div><p><img src="/img/demand_forecasting/plot6.svg" alt="Plot"></p>
<blockquote>
<p>It&rsquo;s clear that China is our most important export trade partner. The others positions have been rotating between Netherlands, Spain and Iran.</p>
</blockquote>
<p>Now, by imports perspective.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># this is the same code, but filtering by importation</span>
imp_trade_partners_corn_sugar_tbl <span style="color:#f92672">&lt;-</span> exp_imp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(year <span style="color:#f92672">=</span> <span style="color:#a6e22e">year</span>(date)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(year <span style="color:#f92672">%in%</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2019</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2014</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Import&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(country2 <span style="color:#f92672">=</span> country <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">str_replace_all</span>(<span style="color:#e6db74">&#34;[[:punct:]]&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">str_trim</span>(side <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;both&#34;</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(year, country2) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_usd <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(usd)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(year_fc <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(year),
         name <span style="color:#f92672">=</span> <span style="color:#a6e22e">reorder_within</span>(country2, total_usd, year_fc))


imp_trade_partners_corn_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(year) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">slice_max</span>(total_usd, n <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> name,
             y <span style="color:#f92672">=</span> total_usd,
             fill <span style="color:#f92672">=</span> year)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>(show.legend <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_flip</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_reordered</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">dollar_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>year, scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Top 3 - Trade Partners Evaluation for the last 5 years of Imports&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Considering Soybean, Soybeans Meal, Soybean Oil, Sugar, Corn and Wheat Commodities&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of U.S. Dollars&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>()


</code></pre></div><p><img src="/img/demand_forecasting/plot7.2.svg" alt="Plot"></p>
<blockquote>
<p>Brazil’s major import trade partners alternate between Argentina, Paraguay, and USA. Curiously, seems that the participation of USA has been decreasing through the time, as opposed to Argentina.</p>
</blockquote>
<h3 id="states-and-commodities">States and Commodities</h3>
<p>Brazil is a huge country, the five largest country in the world, and this gives us different temperature ranges depends on each area you&rsquo;re looking at. This geographical aspect lead to cultures of food been produce in specific regions them others.</p>
<p>Let’s see from which region comes the production of ours commodities, in terms of exports.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">quest_5_tbl <span style="color:#f92672">&lt;-</span> exp_imp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Export&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(state, product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_usd <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(usd)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">top_n</span>(<span style="color:#ae81ff">5</span>)

quest_5_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(product <span style="color:#f92672">=</span> <span style="color:#a6e22e">case_when</span>(
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;corn&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Corn&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybean_meal&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Soybeans Meal&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybean_oil&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Soybean Oil&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sugar&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Sugar&#34;</span>,
    product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybeans&#34;</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Soybeans&#34;</span>,
    <span style="color:#66d9ef">TRUE</span> <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;Wheat&#34;</span>
  ))  <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> total_usd,
             y <span style="color:#f92672">=</span> <span style="color:#a6e22e">reorder_within</span>(state, total_usd, product),
             fill <span style="color:#f92672">=</span> product)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_col</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span>product, scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free&#34;</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">scale_fill_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>( <span style="color:#e6db74">&#34;#1B8BB5&#34;</span>, <span style="color:#e6db74">&#34;#695905&#34;</span>, <span style="color:#e6db74">&#34;#1B60B5&#34;</span>, <span style="color:#e6db74">&#34;#B55C24&#34;</span>, <span style="color:#e6db74">&#34;#B59C12&#34;</span>,<span style="color:#e6db74">&#34;#69381A&#34;</span> )) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_reordered</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-9</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bi&#34;</span>, prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;$&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Billions of U.S. Dollars&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Top 5 - Most Important Brazilian States by Commodities&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Considering Exports&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
  


</code></pre></div><p><img src="/img/demand_forecasting/plot8.svg" alt="Plot"></p>
<blockquote>
<p>Mato Grosso concentrates most of the exports of soybean oil, soybeans and soybean meal, along with Rio Grande do Sul and Paraná. São Paulo, on the other hand, takes part strongly in sugar exports. And very few states export wheat, the most expressive values comes from Rio Grande do Sul, Paraná and Santa Catarina.</p>
</blockquote>
<p><img src="/img/demand_forecasting/calm_down.gif" alt="gif"></p>
<blockquote>
<p>Okay, we cover a lot until now. Take a minute, breathe, because now is <strong>modeling time</strong>!!</p>
</blockquote>
<h2 id="data-modeling">Data Modeling</h2>
<p>As we know, there is 3 time-series to predict the next 3 years of demand in tons: soybean, corn and sugar. I&rsquo;ll model each separately, because by this way is better to understand the underlying rationale behind the data.</p>
<p>Something important to say is that I already tried different approaches of feature engineering and here I’ll show you what had the better performance. Another point to clarify is I’ll be using a modeltime framework workflow, integrated with tidymodels principles (quick review down below).</p>
<p>As this is a first part of this project, we’ll be using just ARIMA family of models, be aware that more advanced topics on modeling and feature engineering will covered in the <strong>second part</strong>.</p>
<h2 id="a-quick-review-of-modeltime">A quick review of modeltime</h2>
<p>For those that aren&rsquo;t familiar with <code>modeltime</code> framework, it&rsquo;s a R package that set up a time series analysis workflow in a very optimized way. The package works as an extension of tidymodels but applied to time series problems.</p>
<p>I&rsquo;ll summarize here the principals verbs used:</p>
<p><img src="/img/demand_forecasting/modeltime_workflow.jpg" alt="post"></p>
<ol>
<li>Collect data and split into training and test sets</li>
<li>Create &amp; Fit Multiple Models</li>
<li>Add fitted models to a <strong>Model Table</strong></li>
<li><strong>Calibrate</strong> the models to a testing set.</li>
<li>Perform Testing Set Forecast &amp; Accuracy Evaluation</li>
<li><strong>Refit</strong> the models to Full Dataset &amp; Forecast Forward</li>
</ol>
<p>To get more details you can access the documantation <a href="https://business-science.github.io/modeltime/articles/getting-started-with-modeltime.html">here</a>.</p>
<h3 id="soybean">Soybean</h3>
<p>The first thing to do is set up our tibble with the right timestamp. And as we already know, the dataset has a monthly periodicity equally spaced (regular time series).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># data wrangling</span>
ts_soybean_tbl <span style="color:#f92672">&lt;-</span> exp_imp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(date, product, tons) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;soybeans&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(date, product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(tons)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>()

<span style="color:#75715e"># visualizing</span>
ts_soybean_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_time_series</span>(.date_var <span style="color:#f92672">=</span> date,
                   .value <span style="color:#f92672">=</span> total_tons, 
                   .interactive <span style="color:#f92672">=</span> F,
                   .smooth <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Soybean Time Series&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot9.svg" alt="plot"></p>
<p>Just by analyzing this visualization, we’re seeing that there is a clear annual seasonality with a multiplicative behavior (values are growing throughout the time). We can verify these assumptions with ACF/PACF charts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># High annual correlation</span>
ts_soybean_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_acf_diagnostics</span>(.date_var <span style="color:#f92672">=</span> date, total_tons,
                       .interactive <span style="color:#f92672">=</span> F,
                       .show_white_noise_bars <span style="color:#f92672">=</span> T) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Soybean Lag Diagnostics&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
</code></pre></div><p><img src="/img/demand_forecasting/plot10.svg" alt="plot"></p>
<p>Here we’re confirm the high correlation with annual lags and also one high partial correlation considering 9, 10 and 11 lags. Is possible to use those features to improve performance, but here we’ll be working with the <code>forecast::auto_arima</code> model that automatic look for lags during the training.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_soybean_tbl <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">plot_seasonal_diagnostics</span>(.date_var <span style="color:#f92672">=</span> date, <span style="color:#a6e22e">log</span>(total_tons),
                            .interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Soybean Seasonal Diagnostics&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Log scale&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
</code></pre></div><p><img src="/img/demand_forecasting/plot11.svg" alt="plot"></p>
<blockquote>
<p>Here we’re seeing that there is quarterly seasonality, every second and third quarters occur an increase in exports.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_soybean_tbl <span style="color:#f92672">%&gt;%</span> 
   <span style="color:#a6e22e">mutate</span>(year <span style="color:#f92672">=</span> <span style="color:#a6e22e">year</span>(date) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_factor</span>(),
         month <span style="color:#f92672">=</span> <span style="color:#a6e22e">month</span>(date, label <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, locale <span style="color:#f92672">=</span> <span style="color:#a6e22e">Sys.setlocale</span>(<span style="color:#e6db74">&#34;LC_COLLATE&#34;</span>, <span style="color:#e6db74">&#34;C&#34;</span>)) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_factor</span>()) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> year,
             y <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_rev</span>(month),
             fill <span style="color:#f92672">=</span> total_tons)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_distiller</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>), direction <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_tile</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey40&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Totals of Exports of Soybeans Across the Years and Months&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Months&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of\nTons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot12.svg" alt="plot"></p>
<blockquote>
<p>Now we have a big picture of what is happening. The second and third quarters of practically all months are darker, indicating a higher amount of exports in those periods.</p>
</blockquote>
<h4 id="modeling-soybean-time-series">Modeling soybean time series</h4>
<p>First thing will be standardize our data, applying a box-cox transformation. This is a method used to variance reduction applying a power transformation. As we’ll be using ARIMA family, is interesting work that way.</p>
<p>We also will keep track of the lambda value, important to back-transform our data after modeling phase.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_boxcox_soybean_tbl <span style="color:#f92672">&lt;-</span> ts_soybean_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_vec</span>(total_tons))
boxcox_soybean_lambda <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.382376781152543</span>

</code></pre></div><p>So, we don’t have so much data to work, actually our time series has 265 observations. That way, I split the data in 5 years of assessment and choose the rest to training.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">soybean_boxcox_splits <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">time_series_split</span>(ts_boxcox_soybean_tbl, assess <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5 years&#34;</span>, cumulative <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
train_soybean_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">training</span>(soybean_boxcox_splits)
test_soybean_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">testing</span>(soybean_boxcox_splits)

soybean_boxcox_splits <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">tk_time_series_cv_plan</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_time_series_cv_plan</span>(date, total_tons, .interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Soybean Training and Testing Splits&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>
  )
</code></pre></div><p><img src="/img/demand_forecasting/plot13.svg" alt="plot"></p>
<p>Now, we can start work with the <code>modeltime</code> workflow showed before.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">auto_arima_formula <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">formula</span>(total_tons <span style="color:#f92672">~</span> .)

<span style="color:#75715e"># training</span>
auto_arima_boxcox_fit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">arima_reg</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">set_engine</span>(<span style="color:#e6db74">&#34;auto_arima&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">fit</span>(auto_arima_formula, train_soybean_boxcox_tbl)

<span style="color:#75715e"># testing</span>
calibration_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">modeltime_table</span>(
  auto_arima_boxcox_fit
) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_calibrate</span>(
    new_data <span style="color:#f92672">=</span> test_soybean_boxcox_tbl)

<span style="color:#75715e"># accuracy on testing data</span>
soybean_boxcox_accuracy <span style="color:#f92672">&lt;-</span> calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_accuracy</span>()
  
</code></pre></div><blockquote>
<p><strong>Brief explanation about the auto-arima implementation:</strong> The auto-arima algo use the AIC metric to optimize the p, q, d and P, Q, D params, looking for the best values. These metrics works like a R-Squared in order to point you to a correct direction.</p>
</blockquote>
<p>You can see in <code>.model_desc</code> column discription or as a legend on the following pictures the best parmans choosed by the model.</p>
<p>We get a good R-Squared (0.792), but is a good idea to visualize how was the fit of the model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># vizualing forecasting</span>
calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(new_data <span style="color:#f92672">=</span> test_soybean_boxcox_tbl,
                     actual_data <span style="color:#f92672">=</span> ts_boxcox_soybean_tbl) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Soybean - Model Performance on Assessment Data&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
    
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot14.svg" alt="plot"></p>
<p>I really liked of this fit, and we’ll stick with this model, seems to get the correct seasonality and trend. The next step is refit the model on all data and see how it works. If needed, the algorithm will update the coefficients to capture the general pattern.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">refit_boxcox_tbl <span style="color:#f92672">&lt;-</span> calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_refit</span>(data <span style="color:#f92672">=</span> ts_boxcox_soybean_tbl) 

refit_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(h <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3 years&#34;</span>, actual_data <span style="color:#f92672">=</span> ts_boxcox_soybean_tbl) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Soybean - Demand Forecast&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Prediction for the next 3 years of Soybean Exports&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

refit_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_accuracy</span>()

</code></pre></div><p><img src="/img/demand_forecasting/plot15.svg" alt="plot"></p>
<blockquote>
<p>Look, every time that you see the &ldquo;UPDATE&rdquo; as a prefix of model description, meaning that the model found better coefficients to explain the data.</p>
</blockquote>
<h4 id="pos-processing-step">Pos-Processing step</h4>
<p>We need back-transform our data because of box-cox transformation at the beginning, and the values don’t represent exports quantities.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">forecast_boxcox_soybean_tbl <span style="color:#f92672">&lt;-</span> refit_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(h <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3 years&#34;</span>, actual_data <span style="color:#f92672">=</span> ts_boxcox_soybean_tbl)

forecast_soybean_tbl <span style="color:#f92672">&lt;-</span> forecast_boxcox_soybean_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(.value <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.value, lambda <span style="color:#f92672">=</span> boxcox_soybean_lambda),
         .conf_lo <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.conf_lo, lambda <span style="color:#f92672">=</span> boxcox_soybean_lambda),
         .conf_hi <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.conf_hi, lambda <span style="color:#f92672">=</span> boxcox_soybean_lambda))

forecast_soybean_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Soybean - Demand Forecast&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Prediction for the next 3 years of Soybean Exports&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot16.svg" alt="plot"></p>
<blockquote>
<p>That is our final result for the demand forecast of the next 3 years of soybean production, with 95% of confidence interval.</p>
</blockquote>
<h3 id="corn">Corn</h3>
<p>Here we&rsquo;ll follow the same workflow as soybean demand forecast showed before.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_corn_tbl <span style="color:#f92672">&lt;-</span> exp_imp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(date, product, tons) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;corn&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(date, product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(tons)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>()

ts_corn_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_time_series</span>(.date_var <span style="color:#f92672">=</span> date,
                   .value <span style="color:#f92672">=</span> total_tons, 
                   .interactive <span style="color:#f92672">=</span> F,
                   .smooth <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Corn Time Series&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot17.svg" alt="plot"></p>
<p>We also have annual seasonality with a multiplicative behavior. Let&rsquo;s look the lag diagnostic.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># High annual correlation</span>
ts_corn_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_acf_diagnostics</span>(.date_var <span style="color:#f92672">=</span> date, total_tons,
                       .interactive <span style="color:#f92672">=</span> F,
                       .show_white_noise_bars <span style="color:#f92672">=</span> T) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Corn Lag Diagnostics&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
</code></pre></div><p><img src="/img/demand_forecasting/plot18.svg" alt="plot"></p>
<blockquote>
<p>Confirm our assumption of annual seasonality.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_corn_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_seasonal_diagnostics</span>(.date_var <span style="color:#f92672">=</span> date, total_tons,
                            .interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Corn Seasonal Diagnostics&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Log scale&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
</code></pre></div><p><img src="/img/demand_forecasting/plot19.svg" alt="plot"></p>
<blockquote>
<p>The interesting of this chart is that we can see a quarterly seasonality too (similiar to soybean seasonal diagnostics), this time with third and fourth quarters.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_corn_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(year <span style="color:#f92672">=</span> <span style="color:#a6e22e">year</span>(date) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_factor</span>(),
         month <span style="color:#f92672">=</span> <span style="color:#a6e22e">month</span>(date, label <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, locale <span style="color:#f92672">=</span> <span style="color:#a6e22e">Sys.setlocale</span>(<span style="color:#e6db74">&#34;LC_COLLATE&#34;</span>, <span style="color:#e6db74">&#34;C&#34;</span>)) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_factor</span>()) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> year,
             y <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_rev</span>(month),
             fill <span style="color:#f92672">=</span> total_tons)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_distiller</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>), direction <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_tile</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey40&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Totals of Corn Exports Across the Years and Months&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Months&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of\nTons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot20.svg" alt="plot"></p>
<blockquote>
<p>Looking at this heatmap is visible that through the years the exports are growing and the period of the year that has more exports (3rd and 4rd quarters).</p>
</blockquote>
<h4 id="modeling-corn-time-series">Modeling corn time series</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># transforming target ----</span>
<span style="color:#75715e"># boxcox</span>
ts_boxcox_corn_tbl <span style="color:#f92672">&lt;-</span> ts_corn_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_vec</span>(total_tons))
boxcox_corn_lambda <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.0676121372845911</span>

<span style="color:#75715e"># visualizing the transformations ----</span>
ts_boxcox_corn_tbl <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">plot_time_series</span>(date, total_tons)

<span style="color:#75715e"># splits ----</span>
<span style="color:#75715e"># boxcox</span>
corn_boxcox_splits <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">time_series_split</span>(ts_boxcox_corn_tbl, assess <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5 years&#34;</span>, cumulative <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
train_corn_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">training</span>(corn_boxcox_splits)
test_corn_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">testing</span>(corn_boxcox_splits)

corn_boxcox_splits <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">tk_time_series_cv_plan</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_time_series_cv_plan</span>(date, total_tons, .interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Corn Training and Testing Splits&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot21.svg" alt="plot"></p>
<p>Our formula here will be different, by including this features our model could better capture the seasonality.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># modeling with modeltime ----</span>
<span style="color:#75715e"># formula</span>
auto_arima_formula <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">formula</span>(total_tons <span style="color:#f92672">~</span> . <span style="color:#f92672">+</span>
                                <span style="color:#a6e22e">year</span>(date) <span style="color:#f92672">+</span>
                                <span style="color:#a6e22e">month</span>(date, label <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>))

<span style="color:#75715e"># training</span>
auto_arima_fit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">arima_reg</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">set_engine</span>(<span style="color:#e6db74">&#34;auto_arima&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">fit</span>(auto_arima_formula, train_corn_boxcox_tbl)

<span style="color:#75715e"># testing</span>
calibration_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">modeltime_table</span>(
  auto_arima_fit
) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_calibrate</span>(
    new_data <span style="color:#f92672">=</span> test_corn_boxcox_tbl
  )

<span style="color:#75715e"># accuracy on testing data</span>
corn_accuracy <span style="color:#f92672">&lt;-</span> calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_accuracy</span>()

<span style="color:#75715e"># vizualing forecasting</span>
calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(new_data <span style="color:#f92672">=</span> test_corn_boxcox_tbl,
                     actual_data <span style="color:#f92672">=</span> ts_boxcox_corn_tbl) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Corn - Model Performance on Assessment Data&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
    
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot22.svg" alt="plot"></p>
<p>The R-Squared here is about 0.643 with good understanding of the seasonality, but the model could not capture the depressions of the time series data. We&rsquo;ll stick with this model for now.</p>
<p>Now let&rsquo;s refit the data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># refiting ----</span>
<span style="color:#75715e"># boxcox</span>
refit_boxcox_tbl <span style="color:#f92672">&lt;-</span> calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_refit</span>(data <span style="color:#f92672">=</span> ts_boxcox_corn_tbl) 

refit_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(h <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3 years&#34;</span>, actual_data <span style="color:#f92672">=</span> ts_boxcox_corn_tbl) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Corn - Demand Forecast&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Prediction for the next 3 years of Soybean Exports&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot23.svg" alt="plot"></p>
<p>This was our final model.</p>
<h4 id="pos-processing-step-1">Pos-Processing step</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># inverting transformation</span>
forecast_boxcox_corn_tbl <span style="color:#f92672">&lt;-</span> refit_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(h <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3 years&#34;</span>, actual_data <span style="color:#f92672">=</span> ts_boxcox_corn_tbl)

forecast_corn_tbl <span style="color:#f92672">&lt;-</span> forecast_boxcox_corn_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(.value <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.value, lambda <span style="color:#f92672">=</span> boxcox_corn_lambda),
         .conf_lo <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.conf_lo, lambda <span style="color:#f92672">=</span> boxcox_corn_lambda),
         .conf_hi <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.conf_hi, lambda <span style="color:#f92672">=</span> boxcox_corn_lambda))

forecast_corn_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Corn - Demand Forecast&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Prediction for the next 3 years of Corn Exports&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot24.svg" alt="plot"></p>
<p>Besides our 95% confidence intervals been so high, our series capture a similar trend and seasonality of previous years.</p>
<h3 id="sugar">Sugar</h3>
<p>Let&rsquo;s investigate the final one.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_sugar_tbl <span style="color:#f92672">&lt;-</span> exp_imp_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(date, product, tons) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(product <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sugar&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(date, product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarise</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum</span>(tons)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>()

ts_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">tk_summary_diagnostics</span>()

ts_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_time_series</span>(.date_var <span style="color:#f92672">=</span> date,
                   .value <span style="color:#f92672">=</span> total_tons, 
                   .interactive <span style="color:#f92672">=</span> F,
                   .smooth <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar Time Series&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot25.svg" alt="plot"></p>
<p>This time series seems to have a change in behavior after the year of 2012, with a high spike and a significant increase in quantity of exports.</p>
<p><strong>What <em>ACF</em> and <em>PACF</em> tell us?</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># High annual correlation</span>
<span style="color:#75715e"># lag 11 and 23 also have good indicate of correlation</span>
ts_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_acf_diagnostics</span>(.date_var <span style="color:#f92672">=</span> date, total_tons,
                       .interactive <span style="color:#f92672">=</span> F,
                       .show_white_noise_bars <span style="color:#f92672">=</span> T) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar Lag Diagnostics&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
  
</code></pre></div><p><img src="/img/demand_forecasting/plot26.svg" alt="plot"></p>
<blockquote>
<p>Here we&rsquo;re seeing a high correlation mostly with recent 70 lags, and negative correlation with older lags. Then in PACF plot, lag 2 and 9 seems important to our model.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_seasonal_diagnostics</span>(.date_var <span style="color:#f92672">=</span> date, <span style="color:#a6e22e">log</span>(total_tons),
                            .interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar Seasonal Diagnostics&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Log scale&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
  
</code></pre></div><p><img src="/img/demand_forecasting/plot27.svg" alt="plot"></p>
<blockquote>
<p>As we confirmed, since 2012 we have higher exports. But looking at this plot, we don&rsquo;t see any seasonality throughout the time.</p>
</blockquote>
<p>So let filter the data and analyse the seasonality after 2012.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter_by_time</span>(date, .start_date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2012-01-01&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_seasonal_diagnostics</span>(.date_var <span style="color:#f92672">=</span> date, total_tons,
                            .interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar Seasonal Diagnostics&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Seasonal diagnostics considering data since 2012&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot28.svg" alt="plot"></p>
<p>Now we can capture an interesting bahavior, seems that the third and first quarter have an increase in exports.</p>
<p>Searching the why of happened this change in 2012, I found some events that probably are correlated to our problem.</p>
<ol>
<li>
<p>2012 was the year that Brazil increases the production of ethanol</p>
</li>
<li>
<p>To produce more ethanol was needed to plant more sugar cane (the base of ethanol production).</p>
</li>
<li>
<p>Sugar also came from sugar cane, so, with more sugar cane cultivation, we saw an increase of sugar production, hence reflected on its exports.</p>
</li>
</ol>
<p>So, there is a huge probability of our time series have really changed its behavior. Another point is that there is a quarterly seasonality that matches exactly with the period of sugar production: 90 days in the summer and 100 days in the winter.</p>
<p>With this context in mind, I’ll use just the data after 2012 for now.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">ts_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(year <span style="color:#f92672">=</span> <span style="color:#a6e22e">year</span>(date) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_factor</span>(),
         month <span style="color:#f92672">=</span> <span style="color:#a6e22e">month</span>(date, label <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, locale <span style="color:#f92672">=</span> <span style="color:#a6e22e">Sys.setlocale</span>(<span style="color:#e6db74">&#34;LC_COLLATE&#34;</span>, <span style="color:#e6db74">&#34;C&#34;</span>)) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">as_factor</span>()) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> year,
             y <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_rev</span>(month),
             fill <span style="color:#f92672">=</span> total_tons)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_distiller</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>), direction <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_tile</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey40&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Totals of Sugar Exports Across the Years and Months&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Months&#34;</span>,
    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
    fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of\nTons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )


</code></pre></div><p><img src="/img/demand_forecasting/plot29.svg" alt="plot"></p>
<blockquote>
<p>Looking at this heatmap, it’s visible that through the years the exports intensified by a huge quantity since 2012.</p>
</blockquote>
<p>I&rsquo;ll choose look just for the years after 2012 to modeling our time series.</p>
<h4 id="modeling-sugar-time-series">Modeling sugar time series</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># transforming target ----</span>
<span style="color:#75715e"># log</span>
ts_boxcox_sugar_tbl <span style="color:#f92672">&lt;-</span> ts_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>product) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter_by_time</span>(date, .start_date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2012-01-01&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(total_tons <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_vec</span>(total_tons))
boxcox_sugar_lambda <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.645806609678906</span>

<span style="color:#75715e"># visualizing the transformations ----</span>
ts_boxcox_sugar_tbl <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">plot_time_series</span>(date, total_tons)


<span style="color:#75715e"># splits ----</span>
<span style="color:#75715e"># boxcox</span>
sugar_boxcox_splits <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">time_series_split</span>(ts_boxcox_sugar_tbl, assess <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;4 years&#34;</span>, cumulative <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
train_sugar_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">training</span>(sugar_boxcox_splits)
test_sugar_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">testing</span>(sugar_boxcox_splits)

sugar_boxcox_splits <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">tk_time_series_cv_plan</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_time_series_cv_plan</span>(date, total_tons, .interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar Training and Testing Splits&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )
</code></pre></div><p><img src="/img/demand_forecasting/plot30.svg" alt="plot"></p>
<blockquote>
<p>Here I needed to change the amount of data used as assessment data to 4 years instead of 5.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># modeling with modeltime ----</span>
<span style="color:#75715e"># Modeling log transformed data</span>
<span style="color:#75715e"># formula</span>
auto_arima_formula <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">formula</span>(total_tons <span style="color:#f92672">~</span> . <span style="color:#f92672">+</span>
                                <span style="color:#a6e22e">month</span>(date, label <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>))

<span style="color:#75715e"># add trimestres</span>

<span style="color:#75715e"># training</span>
<span style="color:#75715e"># modeling with modeltime ----</span>
<span style="color:#75715e"># Modeling boxcox transformed data</span>

<span style="color:#75715e"># training</span>
auto_arima_boxcox_fit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">arima_reg</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">set_engine</span>(<span style="color:#e6db74">&#34;auto_arima&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">fit</span>(auto_arima_formula, train_sugar_boxcox_tbl)

<span style="color:#75715e"># testing</span>
calibration_boxcox_tbl <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">modeltime_table</span>(
  auto_arima_boxcox_fit
) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_calibrate</span>(
    new_data <span style="color:#f92672">=</span> test_sugar_boxcox_tbl)

<span style="color:#75715e"># accuracy on testing data</span>
sugar_boxcox_accuracy <span style="color:#f92672">&lt;-</span> calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_accuracy</span>()

<span style="color:#75715e"># vizualing forecasting</span>
calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(new_data <span style="color:#f92672">=</span> test_sugar_boxcox_tbl,
                     actual_data <span style="color:#f92672">=</span> ts_boxcox_sugar_tbl) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar - Model Performance on Assessment Data&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot31.svg" alt="plot"></p>
<blockquote>
<p>Besides the fit was a little off of the real values, the model could capture a general seasonality and trend. We’ll stick with this model for now.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># refiting ----</span>
<span style="color:#75715e"># boxcox</span>
refit_boxcox_tbl <span style="color:#f92672">&lt;-</span> calibration_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_refit</span>(data <span style="color:#f92672">=</span> ts_boxcox_sugar_tbl) 

refit_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(h <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3 years&#34;</span>, actual_data <span style="color:#f92672">=</span> ts_boxcox_sugar_tbl) <span style="color:#f92672">%&gt;%</span> 
    <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar - Demand Forecast&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Prediction for the next 3 years of Soybean Exports&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BoxCox transformed values&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )

</code></pre></div><p><img src="/img/demand_forecasting/plot32.svg" alt="plot"></p>
<h4 id="pos-processing-step-2">Pos-Processing step</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># inverting transformation</span>
forecast_boxcox_sugar_tbl <span style="color:#f92672">&lt;-</span> refit_boxcox_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">modeltime_forecast</span>(h <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3 years&#34;</span>, actual_data <span style="color:#f92672">=</span> ts_boxcox_sugar_tbl)

forecast_sugar_model2_tbl <span style="color:#f92672">&lt;-</span> forecast_boxcox_sugar_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(.value <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.value, lambda <span style="color:#f92672">=</span> boxcox_sugar_lambda),
         .conf_lo <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.conf_lo, lambda <span style="color:#f92672">=</span> boxcox_sugar_lambda),
         .conf_hi <span style="color:#f92672">=</span> <span style="color:#a6e22e">box_cox_inv_vec</span>(.conf_hi, lambda <span style="color:#f92672">=</span> boxcox_sugar_lambda))

forecast_sugar_model2_tbl <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">plot_modeltime_forecast</span>(.interactive <span style="color:#f92672">=</span> F) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span><span style="color:#a6e22e">number_format</span>(scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>, suffix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;M&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sugar - Demand Forecast&#34;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Prediction for the next 3 years of Corn Exports&#34;</span>,
    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Millions of Tons&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;linkedin.com/in/lucianobatistads/&#34;</span>
  )


</code></pre></div><p><img src="/img/demand_forecasting/plot33.svg" alt="plot"></p>
<p>So, this is our final model to predict the next 3 years of sugar exports, and also the end of this first phase of the project.</p>
<p><img src="/img/demand_forecasting/congrats.gif" alt="gif"></p>
<h3 id="next-steps-important">Next Steps! (Important)</h3>
<p>Throughout the project, we could see that ARIMA family of models is a very powerfull method. But, there is so much machine learning and deep learning algorithms available to work with time series forecasting that this article would be too big if I putt all that here.</p>
<p>Now, that we have a great understanding about our dataset and also we have a really nice baseline model for all three commodities (soybean, corn and sugar), we can go deeper in modeling and cover advanced topics.</p>
<p>As a spoiler to the next part of this project, check this list:</p>
<ul>
<li>Much more different models (<code>modeltime</code>)</li>
<li>Lot more feature engineering (<code>recipes</code>)</li>
<li>Hyperparameter Tunning (<code>tune</code>)</li>
<li>Resampling tecniques (<code>modeltime.resample</code>)</li>
<li>Stacking and ensembles models (<code>modeltime.ensemble</code>)</li>
</ul>
<p>Thanks for your attention, any question please let me know, Bye!</p>
<p>source: <a href="https://www.toppr.com/guides/business-economics/theory-of-demand/demand-forecasting/">https://www.toppr.com/guides/business-economics/theory-of-demand/demand-forecasting/</a>
source: <a href="https://blog.flexis.com/the-benefits-of-forecasting-in-planning-and-production">https://blog.flexis.com/the-benefits-of-forecasting-in-planning-and-production</a></p>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2020/10/13/effective-approach-to-analyze-correlation-coefficients/" data-toggle="tooltip" data-placement="top" title="Effective approach to analyze correlation coefficients">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2021/03/30/criando-uma-api-pronta-para-produ%C3%A7%C3%A3o-com-fastapi-pt.1/" data-toggle="tooltip" data-placement="top" title="Criando uma API Pronta para Produção com FastAPI - PT.1">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/asynchronous" title="asynchronous">
                            asynchronous
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/backend" title="backend">
                            backend
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/data-science" title="data-science">
                            data-science
                        </a>
                        
                        
                        
                        <a href="/tags/data-visualization" title="data-visualization">
                            data-visualization
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/fastapi" title="fastapi">
                            fastapi
                        </a>
                        
                        
                        
                        <a href="/tags/ggplot2" title="ggplot2">
                            ggplot2
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/machine-learning" title="machine-learning">
                            machine-learning
                        </a>
                        
                        
                        
                        <a href="/tags/project" title="project">
                            project
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/r" title="r">
                            r
                        </a>
                        
                        
                        
                        <a href="/tags/restfull-api" title="restfull-api">
                            restfull-api
                        </a>
                        
                        
                        
                        <a href="/tags/sqlalchemy" title="sqlalchemy">
                            sqlalchemy
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/time-series" title="time-series">
                            time-series
                        </a>
                        
                        
                        
                        <a href="/tags/web-development" title="web-development">
                            web-development
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                       <a href="" rel="alternate" type="application/rss+xml" title="LOB.DATA" >
                           <span class="fa-stack fa-lg">
                               <i class="fa fa-circle fa-stack-2x"></i>
                               <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                    </li>
                    
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/LucianoBatista">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		                
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/lucianobatistads/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		                
                    
                </ul>
		<p class="copyright text-muted">
                    A <a href="https://gohugo.io/">HUGO</a> <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite</a> page build with ♥ and powered by <a href="https://www.netlify.com/">Netlify</a>&nbsp;&nbsp;&bull;&nbsp;&nbsp;Header images by <a href="https://www.instagram.com/richard.strozynski/?hl=en">Richard Strozynski</a>
    </p>
    <p class="copyright text-muted" style='font-size:8pt;'>
                    &copy; LOB.DATA 2019–2021. All rights reserved.&nbsp;&nbsp;&bull;&nbsp;&nbsp;<a href="https://lobdata.com.br/top/conduct/">Code of Conduct</a>
                    <br>
                    Content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International license</a>.
                    <br>
                    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#28a87d'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
